{% extends 'base.html' %}

{% block title %}Genel BakÄ±ÅŸ{% endblock %}

{% block content %}
<!-- Easy Mode Dashboard (Visible only in Easy Mode) -->
<div class="easy-mode-dashboard d-none h-100 flex-column justify-content-center align-items-center"
    style="min-height: 80vh;">
    <h1 class="display-4 fw-bold text-primary mb-5">HÄ±zlÄ± Ä°ÅŸlemler</h1>
    <div class="row g-4 w-100 justify-content-center" style="max-width: 1200px;">
        <div class="col-md-4">
            <a href="{{ url_for('add_student', next='index') }}"
                class="card text-decoration-none border-0 shadow hover-scale h-100 text-center py-5 rounded-5 bg-gradient-primary text-white"
                style="background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);">
                <div class="card-body">
                    <i class="fas fa-user-plus fa-6x mb-4"></i>
                    <h2 class="fw-bold">Ã–ÄžRENCÄ° EKLE</h2>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('add_book', next='index') }}"
                class="card text-decoration-none border-0 shadow hover-scale h-100 text-center py-5 rounded-5 bg-gradient-success text-white"
                style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                <div class="card-body">
                    <i class="fas fa-book-medical fa-6x mb-4"></i>
                    <h2 class="fw-bold">KÄ°TAP EKLE</h2>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('loans', next='index') }}"
                class="card text-decoration-none border-0 shadow hover-scale h-100 text-center py-5 rounded-5 bg-gradient-warning text-white"
                style="background: linear-gradient(135deg, #fce38a 0%, #f38181 100%);">
                <div class="card-body">
                    <i class="fas fa-hand-holding fa-6x mb-4"></i>
                    <h2 class="fw-bold">EMANET VER</h2>
                </div>
            </a>
        </div>
    </div>
    <div class="mt-5">
        <a href="{{ url_for('settings') }}" class="btn btn-light btn-lg rounded-pill shadow-sm text-secondary"><i
                class="fas fa-cog me-2"></i>Ayarlar / Ã‡Ä±kÄ±ÅŸ</a>
    </div>
</div>

<!-- Regular Dashboard Content (Hidden in Easy Mode) -->
<div class="regular-dashboard d-none d-lg-block">
    <!-- Welcome Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 fw-bold text-gray-800">HoÅŸ Geldiniz, YÃ¶netici ðŸ‘‹</h1>
            <p class="text-muted mb-0">BugÃ¼n: {{ now.strftime('%d %B %Y') }}</p>
        </div>
        <div>
            <button onclick="window.location.reload()" class="btn btn-light rounded-circle shadow-sm">
                <i class="fas fa-sync-alt text-muted"></i>
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4">
        <!-- Student Stats -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                <div class="card-body p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-4">
                            <i class="fas fa-user-graduate text-primary fa-lg"></i>
                        </div>
                        <span
                            class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill small fw-bold">Ã–ÄŸrenci</span>
                    </div>
                    <div>
                        <h2 class="display-5 fw-bold mb-1">{{ stats.total_students }}</h2>
                        <p class="text-muted small mb-0">Toplam KayÄ±tlÄ±</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Book Stats -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                <div class="card-body p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="bg-success bg-opacity-10 p-3 rounded-4">
                            <i class="fas fa-book text-success fa-lg"></i>
                        </div>
                        <span
                            class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill small fw-bold">Kitap</span>
                    </div>
                    <div>
                        <h2 class="display-5 fw-bold mb-1">{{ stats.total_books }}</h2>
                        <p class="text-muted small mb-0">KÃ¼tÃ¼phane Envanteri</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Loans -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                <div class="card-body p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="bg-warning bg-opacity-10 p-3 rounded-4">
                            <i class="fas fa-hand-holding text-warning fa-lg"></i>
                        </div>
                        <span
                            class="badge bg-warning bg-opacity-10 text-warning px-3 py-2 rounded-pill small fw-bold">Emanet</span>
                    </div>
                    <div>
                        <h2 class="display-5 fw-bold mb-1">{{ stats.active_loans }}</h2>
                        <p class="text-muted small mb-0">Okunan Kitaplar</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overdue -->
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                <div class="card-body p-4 position-relative">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="bg-danger bg-opacity-10 p-3 rounded-4">
                            <i class="fas fa-clock text-danger fa-lg"></i>
                        </div>
                        <span
                            class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill small fw-bold">GecikmiÅŸ</span>
                    </div>
                    <div>
                        <h2 class="display-5 fw-bold mb-1">{{ stats.overdue_loans }}</h2>
                        <p class="text-muted small mb-0">Acil Ä°ade Bekleyen</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions (Full Width) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm rounded-4 bg-primary text-white overflow-hidden"
                style="background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);">
                <div class="card-body p-4">
                    <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
                        <h5 class="fw-bold mb-0 text-white"><i class="fas fa-bolt me-2"></i>HÄ±zlÄ± EriÅŸim</h5>
                        <div class="d-flex gap-3 flex-wrap">
                            <a href="{{ url_for('loans') }}"
                                class="btn btn-light border-0 px-4 py-2 fw-bold text-primary shadow-sm hover-scale">
                                <i class="fas fa-plus-circle me-2"></i>Emanet Ver
                            </a>
                            <a href="{{ url_for('add_student') }}"
                                class="btn btn-outline-light border-2 px-4 py-2 fw-bold">
                                <i class="fas fa-user-plus me-2"></i>Ã–ÄŸrenci KayÄ±t
                            </a>
                            <a href="{{ url_for('add_book') }}"
                                class="btn btn-outline-light border-2 px-4 py-2 fw-bold">
                                <i class="fas fa-book-medical me-2"></i>Kitap KayÄ±t
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row g-4 mb-4">
        <!-- Left Side: Tables (9 Cols) -->
        <div class="col-xl-9">
            <div class="row g-4">
                <!-- Recent Activity -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4">
                        <div
                            class="card-header bg-white border-0 py-3 px-4 d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0 text-gray-800"><i class="fas fa-history text-secondary me-2"></i>Son
                                Hareketler</h5>
                            <a href="{{ url_for('loans') }}" class="btn btn-sm btn-light rounded-pill px-3">TÃ¼mÃ¼nÃ¼
                                GÃ¶r</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4 py-3">Ã–ÄŸrenci</th>
                                            <th class="py-3">Kitap</th>
                                            <th class="py-3">Tarih</th>
                                            <th class="py-3">Durum</th>
                                            <th class="text-end pe-4 py-3">Detay</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for transaction in recent_transactions[:5] %}
                                        <tr>
                                            <td class="ps-4 fw-medium">{{ transaction.student.name }} {{
                                                transaction.student.surname }}</td>
                                            <td>{{ transaction.book.title }}</td>
                                            <td class="text-muted small">{{ transaction.issue_date.strftime('%d.%m.%Y')
                                                }}
                                            </td>
                                            <td>
                                                {% if transaction.status == 'active' %}
                                                <span
                                                    class="badge bg-warning-subtle text-warning border border-warning-subtle px-2 py-1 rounded-pill small">Emanet</span>
                                                {% else %}
                                                <span
                                                    class="badge bg-success-subtle text-success border border-success-subtle px-2 py-1 rounded-pill small">Ä°ade</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end pe-4">
                                                <a href="{{ url_for('student_detail', id=transaction.student.id) }}"
                                                    class="btn btn-sm btn-light rounded-circle">
                                                    <i class="fas fa-chevron-right text-muted"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center py-4 text-muted">Ä°ÅŸlem yok.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overdue Loans -->
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div
                            class="card-header bg-white border-0 py-3 px-4 d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0 text-danger"><i class="fas fa-exclamation-circle me-2"></i>GecikmiÅŸ
                                Ä°adeler</h5>
                            <span class="badge bg-danger rounded-pill">{{ overdue_loans|length }}</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th class="ps-4 py-3">Ã–ÄŸrenci</th>
                                            <th>Kitap</th>
                                            <th>Teslim Tarihi</th>
                                            <th class="text-end pe-4">Ä°ÅŸlem</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for loan in overdue_loans %}
                                        <tr>
                                            <td class="ps-4 fw-medium">{{ loan.student.name }} {{ loan.student.surname
                                                }}
                                            </td>
                                            <td>{{ loan.book.title }}</td>
                                            <td><span class="badge bg-danger">{{ loan.due_date.strftime('%d.%m.%Y')
                                                    }}</span></td>
                                            <td class="text-end pe-4">
                                                <form action="{{ url_for('return_book', transaction_id=loan.id) }}"
                                                    method="POST" class="d-inline">
                                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                    <button type="submit"
                                                        class="btn btn-sm btn-outline-danger rounded-pill px-3">Ä°ade
                                                        Al</button>
                                                </form>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center py-4 text-muted">
                                                <i class="fas fa-check-circle text-success me-2"></i>Sorun yok!
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side: Calendar (3 Cols) -->
        <div class="col-xl-3">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <!-- New Calendar Design Logic -->
                <div class="calendar-wrapper p-3">
                    <div class="calendar-header d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-sm text-primary fw-bold" onclick="changeMonth(-1)"><i
                                class="fas fa-chevron-left"></i></button>
                        <div id="monthYearDisplay" class="fw-bold text-primary" style="font-size: 1.1rem;"></div>
                        <button class="btn btn-sm text-primary fw-bold" onclick="changeMonth(1)"><i
                                class="fas fa-chevron-right"></i></button>
                    </div>

                    <div
                        class="calendar-weekdays d-flex justify-content-between mb-2 text-primary small fw-bold text-uppercase">
                        <div>Pzt</div>
                        <div>Sal</div>
                        <div>Ã‡ar</div>
                        <div>Per</div>
                        <div>Cum</div>
                        <div>Cmt</div>
                        <div>Paz</div>
                    </div>

                    <div id="calendarDays" class="calendar-days d-flex flex-wrap">
                        <!-- Days will be injected here via JS -->
                        <div class="d-flex justify-content-center align-items-center w-100 py-5">
                            <i class="fas fa-spinner fa-spin text-primary"></i>
                        </div>
                    </div>
                </div>

                <!-- Custom Styles for Calendar -->
                <style>
                    .calendar-wrapper {
                        font-family: 'Segoe UI', sans-serif;
                        background: #fff;
                        border-radius: 12px;
                    }

                    .calendar-header button {
                        background: none;
                        border: none;
                        cursor: pointer;
                        font-size: 1.2rem;
                    }

                    .calendar-weekdays div {
                        width: 14.28%;
                        text-align: center;
                        color: #3f51b5;
                        font-size: 0.85rem;
                    }

                    .calendar-days div {
                        width: 14.28%;
                        height: 40px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        cursor: default;
                        margin-bottom: 5px;
                        font-size: 0.95rem;
                        color: #444;
                        border-radius: 8px;
                        /* Softer shape */
                        position: relative;
                    }

                    .calendar-days div:hover:not(.empty-day):not(.other-month) {
                        background-color: #f0f3f8;
                        cursor: pointer;
                    }

                    .calendar-days .current-day {
                        background-color: #4285f4;
                        color: white !important;
                        font-weight: bold;
                        box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
                    }

                    .calendar-days .other-month {
                        color: #ccc;
                    }

                    /* Event Indicators */
                    .event-dot {
                        width: 6px;
                        height: 6px;
                        border-radius: 50%;
                        margin-top: 2px;
                    }

                    .dot-red {
                        background-color: #e74c3c;
                        box-shadow: 0 0 4px rgba(231, 76, 60, 0.4);
                    }

                    .dot-yellow {
                        background-color: #f1c40f;
                        box-shadow: 0 0 4px rgba(241, 196, 15, 0.4);
                    }

                    .dot-blue {
                        background-color: #3498db;
                    }

                    /* Multiple dots container */
                    .dots-container {
                        display: flex;
                        gap: 2px;
                        margin-top: 2px;
                    }
                </style>

                <!-- Legend/Stats -->
                <div class="card-footer bg-white border-0 pt-0 pb-3">
                    <div class="d-flex flex-column gap-2 text-xs ps-1 mt-2 border-top pt-2">
                        <div class="d-flex align-items-center justify-content-between">
                            <small class="text-muted">BugÃ¼n</small>
                            <span class="badge bg-primary rounded-pill">{{ now.strftime('%d.%m') }}</span>
                        </div>
                        <div class="d-flex gap-3 justify-content-center mt-1">
                            <div class="d-flex align-items-center"><span class="event-dot dot-red me-1"></span> <small
                                    class="text-muted">Acil/GecikmiÅŸ</small></div>
                            <div class="d-flex align-items-center"><span class="event-dot dot-yellow me-1"></span>
                                <small class="text-muted">YaklaÅŸan</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Detail Modal -->
    <div class="modal fade" id="dayDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 border-0 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary" id="modalDateTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">Bu tarihte iadesi beklenen kitaplar:</p>
                    <div id="modalEventList" class="d-flex flex-column gap-2">
                        <!-- Events injected here -->
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

</div> <!-- End .regular-dashboard -->

<!-- NEW DEDICATED MOBILE DASHBOARD (Visible only on Mobile) -->
<div class="mobile-dashboard-view d-lg-none pb-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 px-1">
        <div>
            <h1 class="h4 fw-bold text-dark mb-0">Merhaba, YÃ¶netici ðŸ‘‹</h1>
            <p class="text-muted small mb-0">{{ now.strftime('%d %B %Y') }}</p>
        </div>
        <a href="{{ url_for('settings') }}" class="btn btn-light rounded-circle shadow-sm"
            style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-cog text-secondary"></i>
        </a>
    </div>

    <!-- Horizontal Stats Scroll -->
    <div class="d-flex overflow-auto pb-4 gap-3 invisible-scrollbar" style="margin: 0 -1rem; padding: 0 1rem;">
        <!-- Card 1 -->
        <div class="card border-0 shadow-sm rounded-4 flex-shrink-0" style="width: 160px; background: #eef2ff;">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <div class="bg-white p-2 rounded-circle shadow-sm"
                        style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-graduate text-primary"></i>
                    </div>
                    <span class="fw-bold text-dark small">Ã–ÄŸrenci</span>
                </div>
                <h3 class="fw-bold mb-0 text-primary">{{ stats.total_students }}</h3>
            </div>
        </div>
        <!-- Card 2 -->
        <div class="card border-0 shadow-sm rounded-4 flex-shrink-0" style="width: 160px; background: #e6fffa;">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <div class="bg-white p-2 rounded-circle shadow-sm"
                        style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-book text-success"></i>
                    </div>
                    <span class="fw-bold text-dark small">Kitap</span>
                </div>
                <h3 class="fw-bold mb-0 text-success">{{ stats.total_books }}</h3>
            </div>
        </div>
        <!-- Card 3 -->
        <div class="card border-0 shadow-sm rounded-4 flex-shrink-0" style="width: 160px; background: #fff8e1;">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <div class="bg-white p-2 rounded-circle shadow-sm"
                        style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-hand-holding text-warning"></i>
                    </div>
                    <span class="fw-bold text-dark small">Emanet</span>
                </div>
                <h3 class="fw-bold mb-0 text-warning">{{ stats.active_loans }}</h3>
            </div>
        </div>
        <!-- Card 4 -->
        <div class="card border-0 shadow-sm rounded-4 flex-shrink-0" style="width: 160px; background: #ffebee;">
            <div class="card-body p-3">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <div class="bg-white p-2 rounded-circle shadow-sm"
                        style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-clock text-danger"></i>
                    </div>
                    <span class="fw-bold text-dark small">GecikmiÅŸ</span>
                </div>
                <h3 class="fw-bold mb-0 text-danger">{{ stats.overdue_loans }}</h3>
            </div>
        </div>
    </div>

    <!-- Quick Actions Grid -->
    <h5 class="fw-bold mb-3 px-1">HÄ±zlÄ± Ä°ÅŸlemler</h5>
    <div class="row g-3 mb-4">
        <div class="col-6">
            <a href="{{ url_for('add_book') }}"
                class="card border-0 shadow-sm rounded-4 text-decoration-none bg-primary text-white h-100">
                <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center">
                    <i class="fas fa-book-medical fa-2x mb-2"></i>
                    <span class="fw-bold small">Kitap Ekle</span>
                </div>
            </a>
        </div>
        <div class="col-6">
            <a href="{{ url_for('loans') }}"
                class="card border-0 shadow-sm rounded-4 text-decoration-none bg-dark text-white h-100">
                <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center">
                    <i class="fas fa-exchange-alt fa-2x mb-2"></i>
                    <span class="fw-bold small">Emanet Ver</span>
                </div>
            </a>
        </div>
        <div class="col-6">
            <a href="{{ url_for('add_student') }}"
                class="card border-0 shadow-sm rounded-4 text-decoration-none bg-white text-dark h-100">
                <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center">
                    <i class="fas fa-user-plus fa-2x mb-2 text-primary"></i>
                    <span class="fw-bold small">Ã–ÄŸrenci Ekle</span>
                </div>
            </a>
        </div>
        <div class="col-6">
            <a href="{{ url_for('statistics') }}"
                class="card border-0 shadow-sm rounded-4 text-decoration-none bg-white text-dark h-100">
                <div class="card-body p-3 d-flex flex-column align-items-center justify-content-center text-center">
                    <i class="fas fa-chart-pie fa-2x mb-2 text-success"></i>
                    <span class="fw-bold small">Ä°statistikler</span>
                </div>
            </a>
        </div>
    </div>

    <!-- Recent Activity List (Mobile) -->
    <div class="d-flex justify-content-between align-items-center mb-3 px-1">
        <h5 class="fw-bold mb-0">Son Hareketler</h5>
        <a href="{{ url_for('loans') }}" class="text-decoration-none small fw-bold">TÃ¼mÃ¼</a>
    </div>

    <div class="d-flex flex-column gap-3">
        {% for transaction in recent_transactions[:5] %}
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-3 d-flex align-items-center">
                <div
                    class="rounded-circle p-3 d-flex align-items-center justify-content-center me-3 {{ 'bg-warning-subtle text-warning' if transaction.status == 'active' else 'bg-success-subtle text-success' }}">
                    <i class="fas {{ 'fa-hand-holding' if transaction.status == 'active' else 'fa-check' }}"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-0 text-dark">{{ transaction.student.name }} {{ transaction.student.surname }}
                    </h6>
                    <p class="text-muted small mb-0">{{ transaction.book.title }}</p>
                </div>
                <div class="text-end">
                    <span class="d-block small fw-bold text-muted">{{ transaction.issue_date.strftime('%d.%m') }}</span>
                    {% if transaction.status == 'active' %}
                    <span class="badge bg-warning text-dark" style="font-size: 0.6rem;">Emanet</span>
                    {% else %}
                    <span class="badge bg-success" style="font-size: 0.6rem;">Ä°ade</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-4 text-muted small">Herhangi bir iÅŸlem yok.</div>
        {% endfor %}
    </div>

    <!-- Helper CSS for Mobile View -->
    <style>
        .invisible-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .invisible-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</div>

<script>
    let currentDate = new Date();
    let globalEvents = []; // Store fetched events

    // Fetch events once on load
    async function fetchEvents() {
        try {
            const response = await fetch('/api/calendar/events');
            globalEvents = await response.json();
            renderCalendar(); // Render after fetch
        } catch (error) {
            console.error('Error fetching calendar events:', error);
            // Render anyway so calendar works even if API fails
            renderCalendar();
        }
    }

    function renderCalendar() {
        const monthYearDisplay = document.getElementById('monthYearDisplay');
        const calendarDays = document.getElementById('calendarDays');

        const months = ["Ocak", "Åžubat", "Mart", "Nisan", "MayÄ±s", "Haziran", "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"];
        monthYearDisplay.innerText = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

        calendarDays.innerHTML = "";

        const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const lastDayOfPrevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);

        let firstDayIndex = firstDayOfMonth.getDay();
        if (firstDayIndex === 0) firstDayIndex = 7;

        // Previous month filler
        for (let i = firstDayIndex - 1; i > 0; i--) {
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('other-month');
            dayDiv.innerText = lastDayOfPrevMonth.getDate() - i + 1;
            calendarDays.appendChild(dayDiv);
        }

        // Current month days
        const today = new Date();

        for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
            const dayDiv = document.createElement('div');
            const dayNum = i;
            dayDiv.innerText = i > 9 ? i : "0" + i;

            // Construct date string for comparison YYYY-MM-DD
            // Careful with Month: JS month is 0-11, we need 01-12
            // Also need padding for single digit months/days
            const currentMonthReal = currentDate.getMonth() + 1;
            const dateStr = `${currentDate.getFullYear()}-${String(currentMonthReal).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;

            // Event Check
            // Filter events for this day
            const daysEvents = globalEvents.filter(e => e.start === dateStr);

            if (daysEvents.length > 0) {
                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'dots-container';

                // Priority color logic: Red > Yellow > Blue
                let hasRed = daysEvents.some(e => e.color === '#e74c3c');
                let hasYellow = daysEvents.some(e => e.color === '#f39c12');

                const dot = document.createElement('span');
                dot.className = 'event-dot';

                if (hasRed) dot.classList.add('dot-red');
                else if (hasYellow) dot.classList.add('dot-yellow');
                else dot.classList.add('dot-blue');

                dotsContainer.appendChild(dot);
                dayDiv.appendChild(dotsContainer);

                // Add click event for details
                dayDiv.onclick = () => openDayDetails(dateStr, daysEvents);
            }

            // Highlight today
            if (i === today.getDate() && currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear()) {
                dayDiv.classList.add('current-day');
                // Improve contrast for dot if on today blue bg
                if (daysEvents.length > 0) {
                    dayDiv.lastChild.firstChild.style.borderColor = 'white';
                    dayDiv.lastChild.firstChild.style.borderWidth = '1px';
                    dayDiv.lastChild.firstChild.style.borderStyle = 'solid';
                }
            }

            calendarDays.appendChild(dayDiv);
        }

        // Next month filler
        const totalBox = calendarDays.children.length;
        const nextDays = 42 - totalBox;

        for (let j = 1; j <= nextDays && nextDays < 14; j++) {
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('other-month');
            dayDiv.innerText = j > 9 ? j : "0" + j;
            calendarDays.appendChild(dayDiv);
        }
    }

    function openDayDetails(dateStr, events) {
        const titleEl = document.getElementById('modalDateTitle');
        const listEl = document.getElementById('modalEventList');

        // Format date nice for title
        const [y, m, d] = dateStr.split('-');
        titleEl.innerText = `${d}.${m}.${y} Ä°ade Listesi`;

        listEl.innerHTML = '';

        events.forEach(e => {
            const item = document.createElement('div');
            item.className = 'p-2 rounded bg-light border d-flex align-items-center justify-content-between';

            let badgeClass = 'bg-primary';
            let badgeText = 'Normal';

            if (e.color === '#e74c3c') { badgeClass = 'bg-danger'; badgeText = 'Acil'; }
            else if (e.color === '#f39c12') { badgeClass = 'bg-warning text-dark'; badgeText = 'YakÄ±n'; }

            item.innerHTML = `
                <div>
                    <div class="fw-bold text-dark small">${e.title.split('-')[0]}</div>
                    <div class="text-muted ms-1" style="font-size:0.75rem;">${e.title.split('-')[1] || ''}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                     <span class="badge ${badgeClass} rounded-pill" style="font-size: 0.65rem;">${badgeText}</span>
                     ${e.url ? `<a href="${e.url}" class="btn btn-sm btn-white border shadow-sm rounded-circle" Title="Git"><i class="fas fa-arrow-right fa-xs text-muted"></i></a>` : ''}
                </div>
            `;
            listEl.appendChild(item);
        });

        const modal = new bootstrap.Modal(document.getElementById('dayDetailModal'));
        modal.show();
    }

    function changeMonth(step) {
        currentDate.setMonth(currentDate.getMonth() + step);
        renderCalendar();
    }

    document.addEventListener('DOMContentLoaded', function () {
        fetchEvents();
    });
</script>
{% endblock %}