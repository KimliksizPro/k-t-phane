{% extends "base.html" %}

{% block title %}G√ºvenlik Merkezi{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 fw-bold text-gray-800">G√ºvenlik Merkezi (WAF) üõ°Ô∏è</h1>
                <p class="text-muted mb-0">Titanium Koruma Kalkanƒ± Durumu ve ƒ∞statistikleri</p>
            </div>
            <button onclick="location.reload()" class="btn btn-light rounded-circle shadow-sm">
                <i class="fas fa-sync-alt text-muted"></i>
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="bg-primary bg-opacity-10 p-3 rounded-4">
                        <i class="fas fa-shield-virus text-primary fa-lg"></i>
                    </div>
                    <span
                        class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill small fw-bold">Toplam</span>
                </div>
                <div>
                    <h2 class="display-5 fw-bold mb-1">{{ stats.total_threats }}</h2>
                    <p class="text-muted small mb-0">Engellenen Tehdit</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="bg-danger bg-opacity-10 p-3 rounded-4">
                        <i class="fas fa-ban text-danger fa-lg"></i>
                    </div>
                    <span
                        class="badge bg-danger bg-opacity-10 text-danger px-3 py-2 rounded-pill small fw-bold">Yasaklƒ±</span>
                </div>
                <div>
                    <h2 class="display-5 fw-bold mb-1">{{ stats.banned_count }}</h2>
                    <p class="text-muted small mb-0">Banlanan IP Adresi</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="bg-success bg-opacity-10 p-3 rounded-4">
                        <i class="fas fa-server text-success fa-lg"></i>
                    </div>
                    <span
                        class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill small fw-bold">Durum</span>
                </div>
                <div>
                    <h2 class="h3 fw-bold mb-1 text-success">AKTƒ∞F</h2>
                    <p class="text-muted small mb-0">Sistem Korumada</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="bg-warning bg-opacity-10 p-3 rounded-4">
                        <i class="fas fa-layer-group text-warning fa-lg"></i>
                    </div>
                    <span
                        class="badge bg-warning bg-opacity-10 text-warning px-3 py-2 rounded-pill small fw-bold">Mod</span>
                </div>
                <div>
                    <h2 class="h3 fw-bold mb-1 text-primary">TITANIUM</h2>
                    <p class="text-muted small mb-0">Paranoid Seviye</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Recent Logs -->
    <div class="col-xl-8">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white border-0 py-3 px-4 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-gray-800"><i class="fas fa-file-contract text-secondary me-2"></i>Son
                    Saldƒ±rƒ± Giri≈üimleri</h5>
                <span class="badge bg-light text-dark border">Son 100 Kayƒ±t</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light sticky-top">
                            <tr>
                                <th class="ps-4 py-3">Zaman</th>
                                <th>IP Adresi</th>
                                <th>ƒ∞≈ülem</th>
                                <th>Bulgu</th>
                                <th>Y√∂net</th>
                                <th class="text-end pe-4">Risk</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in logs %}
                            <tr>
                                <td class="ps-4 text-muted small" style="white-space:nowrap;">{{
                                    log.zaman_damgasi[:19].replace('T', ' ') }}</td>
                                <td class="fw-bold font-monospace text-primary">{{ log.kaynak.ip }}</td>
                                <td>
                                    {% if log.analiz.aksiyon == 'BAN' %}
                                    <span class="badge bg-danger rounded-pill px-3">BAN</span>
                                    {% elif log.analiz.aksiyon == 'BLOCK' %}
                                    <span class="badge bg-warning text-dark rounded-pill px-3">BLOKE</span>
                                    {% else %}
                                    <span class="badge bg-info text-dark rounded-pill px-3">LOG</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if log.analiz.bulgular %}
                                    <span class="text-dark small">{{ log.analiz.bulgular|join(', ')|truncate(50)
                                        }}</span>
                                    {% else %}
                                    <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-light border dropdown-toggle py-0" type="button"
                                            data-bs-toggle="dropdown">
                                            ƒ∞≈ülem
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item text-danger" href="javascript:void(0)"
                                                    onclick="manageIP('{{ log.kaynak.ip }}', 'ban')"><i
                                                        class="fas fa-ban me-2"></i>Yasakla</a></li>
                                            <li><a class="dropdown-item text-success" href="javascript:void(0)"
                                                    onclick="manageIP('{{ log.kaynak.ip }}', 'unban')"><i
                                                        class="fas fa-check me-2"></i>Kaldƒ±r</a></li>
                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>
                                            <li><a class="dropdown-item text-secondary" href="javascript:void(0)"
                                                    onclick="manageIP('{{ log.kaynak.ip }}', 'reset')"><i
                                                        class="fas fa-broom me-2"></i>Temizle</a></li>
                                        </ul>
                                    </div>
                                </td>
                                <td class="text-end pe-4 fw-bold">
                                    {% if log.analiz.risk_skoru >= 100 %}
                                    <span class="text-danger">{{ log.analiz.risk_skoru }}</span>
                                    {% elif log.analiz.risk_skoru >= 50 %}
                                    <span class="text-warning">{{ log.analiz.risk_skoru }}</span>
                                    {% else %}
                                    <span class="text-success">{{ log.analiz.risk_skoru }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-check-circle text-success fa-2x mb-3 d-block"></i>
                                    Hen√ºz tehdit kaydƒ± bulunmuyor.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Banned IPs List -->
    <div class="col-xl-4">
        <div class="card border-0 shadow-sm rounded-4 h-100">
            <div class="card-header bg-white border-0 py-3 px-4 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0 text-danger"><i class="fas fa-user-slash me-2"></i>Kara Liste</h5>
                <span class="badge bg-danger rounded-pill">{{ banned_ips|length }}</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light sticky-top">
                            <tr>
                                <th class="ps-4">IP</th>
                                <th>Sebep</th>
                                <th>ƒ∞≈ülem</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ip, data in banned_ips.items() %}
                            <tr>
                                <td class="ps-4 fw-bold font-monospace">{{ ip }}</td>
                                <td class="small">{{ data.reason|truncate(20) }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-success border-0"
                                        onclick="manageIP('{{ ip }}', 'unban')" title="Yasaƒüƒ± Kaldƒ±r">
                                        <i class="fas fa-unlock"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="2" class="text-center py-5 text-muted">
                                    Yasaklƒ± IP yok.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function manageIP(ip, action) {
        let actionText = action === 'ban' ? 'Yasakla' : (action === 'unban' ? 'Yasaƒüƒ± Kaldƒ±r' : 'Temize √áƒ±kar');
        if (!confirm(ip + ' adresi i√ßin i≈ülem: ' + actionText + '. Onaylƒ±yor musunuz?')) return;

        const csrfToken = "{{ csrf_token() }}";

        fetch('/api/security/ip-action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ ip: ip, action: action })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Hata: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Bir hata olu≈ütu.');
            });
    }
</script>
{% endblock %}